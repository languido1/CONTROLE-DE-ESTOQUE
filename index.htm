<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Armações</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
      color: #333;
    }
    #login-container {
      max-width: 320px;
      margin: 50px auto;
      padding: 20px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #login-container input {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    #login-container button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    #login-container button:hover {
      background-color: #0056b3;
    }
    #errorMsg {
      color: red;
      height: 18px;
      font-size: 14px;
    }

    #dashboard {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header button {
      padding: 6px 14px;
      cursor: pointer;
      background: #dc3545;
      border: none;
      color: white;
      border-radius: 4px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    header button:hover {
      background: #a71d2a;
    }
    #search-store {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .store-card {
      cursor: pointer;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 6px;
      background: #fafafa;
      transition: box-shadow 0.3s;
    }
    .store-card:hover {
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      background: #f0f8ff;
    }

    #armações-section button {
      margin-bottom: 15px;
      padding: 8px 15px;
      background: #007bff;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    #armações-section button:hover {
      background: #0056b3;
    }

    #filtros-container {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    #filtros-container label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      font-size: 14px;
      color: #555;
      min-width: 150px;
    }
    #filtros-container select {
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }
    tbody tr:hover {
      background-color: #f1faff;
    }

    @media(max-width: 600px) {
      #filtros-container {
        flex-direction: column;
      }
      #filtros-container label {
        min-width: auto;
      }
    }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login-container">
    <h2>Login</h2>
    <form id="loginForm">
      <input id="usuario" type="text" placeholder="Usuário" required />
      <input id="senha" type="password" placeholder="Senha" required />
      <button type="submit">Entrar</button>
    </form>
    <div id="errorMsg"></div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <header>
      <span>Usuário: <strong class="username"></strong></span>
      <button onclick="fazerLogout()">Sair</button>
    </header>

    <!-- Lista de Lojas -->
    <section id="lojas-section">
      <input id="search-store" type="text" placeholder="Pesquisar lojas..." />
      <div id="lojas-list"></div>
    </section>

    <!-- Detalhes das Armações -->
    <section id="armações-section" style="display:none;">
      <button onclick="voltarParaLojas()">← Voltar para lojas</button>
      <h2 id="titulo-loja"></h2>

      <div id="filtros-container">
        <label>Marca:
          <select id="filtro-marca" onchange="filtrarArmações()">
            <option value="">Todas</option>
          </select>
        </label>
        <label>Modelo:
          <select id="filtro-modelo" onchange="filtrarArmações()">
            <option value="">Todos</option>
          </select>
        </label>
        <label>Categoria:
          <select id="filtro-categoria" onchange="filtrarArmações()">
            <option value="">Todas</option>
          </select>
        </label>
      </div>

      <table id="tabela-armações">
        <thead>
          <tr>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Quantidade</th>
            <th>Preço</th>
            <th>Categoria</th>
          </tr>
        </thead>
        <tbody>
          <!-- Linhas dinâmicas -->
        </tbody>
      </table>
    </section>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw66jjlRRG7RuzOqApSiMOVY270KOMQ_og0bKTVJrMAi46JvIgkcUaQs1GXsfaHs8Pv/exec";
    let dadosLojas = {};
    let usuarioLogado = null;
    let lojaSelecionada = null;
    let armaçõesFiltradas = [];

    // LOGIN
    function processarLogin(event) {
      event.preventDefault();
      const usuario = document.getElementById("usuario").value;
      const senha = document.getElementById("senha").value;
      const errorMsg = document.getElementById("errorMsg");

      if (usuario === "admin" && senha === "1234") {
        usuarioLogado = usuario;
        document.getElementById("login-container").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.querySelector(".username").textContent = usuario;
        carregarDados();
      } else {
        errorMsg.textContent = "Usuário ou senha incorretos!";
      }
    }

    function fazerLogout() {
      usuarioLogado = null;
      lojaSelecionada = null;
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("login-container").style.display = "flex";
      document.getElementById("usuario").value = "";
      document.getElementById("senha").value = "";
      document.getElementById("errorMsg").textContent = "";
      limparTelaDeArmações();
    }

    // CARREGAR DADOS
    async function carregarDados() {
      try {
        const proxyURL = `https://corsproxy.io/?${encodeURIComponent(API_URL)}`;
        const resposta = await fetch(proxyURL);
        if (!resposta.ok) throw new Error("Erro ao acessar a planilha.");

        const dados = await resposta.json();
        dadosLojas = {};

        dados.lojas.forEach(item => {
          const loja = (item.Loja || "SEM NOME").toUpperCase().trim();
          if (!dadosLojas[loja]) dadosLojas[loja] = [];
          dadosLojas[loja].push({
            marca: item.Marca || "",
            modelo: item.Modelo || "",
            quantidade: parseInt(item.Quantidade) || 0,
            preco: item.Preço ? `R$ ${item.Preço}` : "R$ 0,00",
            categoria: item.Categoria || ""
          });
        });

        carregarLojas();
      } catch (erro) {
        console.error("Erro ao carregar dados:", erro);
        alert("Erro ao carregar dados da planilha.");
      }
    }

    // MOSTRAR LISTA DE LOJAS
    function carregarLojas() {
      const lojasList = document.getElementById("lojas-list");
      const lojas = Object.keys(dadosLojas);

      if (lojas.length === 0) {
        lojasList.innerHTML = "<p style='text-align:center; color:#666;'>Nenhuma loja cadastrada.</p>";
        return;
      }

      lojasList.innerHTML = lojas.map(loja => {
        const totalArmacoes = dadosLojas[loja].length;
        const totalQuantidade = dadosLojas[loja].reduce((sum, item) => sum + item.quantidade, 0);

        return `
          <div class="store-card" onclick="abrirLoja('${loja}')">
            <h3>${loja}</h3>
            <p><strong>${totalArmacoes}</strong> modelos de armações</p>
            <p><strong>${totalQuantidade}</strong> unidades no total</p>
          </div>
        `;
      }).join('');
    }

    // AO CLICAR NA LOJA
    function abrirLoja(loja) {
      lojaSelecionada = loja;
      document.getElementById("lojas-section").style.display = "none";
      document.getElementById("armações-section").style.display = "block";
      document.getElementById("titulo-loja").textContent = loja;

      armaçõesFiltradas = dadosLojas[lojaSelecionada];
      popularFiltros();
      filtrarArmações();
    }

    // LIMPAR TELA DE ARMAÇÕES AO VOLTAR
    function limparTelaDeArmações() {
      document.getElementById("armações-section").style.display = "none";
      document.getElementById("lojas-section").style.display = "block";
      lojaSelecionada = null;
      armaçõesFiltradas = [];
      document.getElementById("titulo-loja").textContent = "";
      limparFiltros();
      limparTabela();
    }

    // VOLTAR PARA LISTA DE LOJAS
    function voltarParaLojas() {
      limparTelaDeArmações();
    }

    // POPULAR FILTROS DINÂMICOS
    function popularFiltros() {
      const marcas = [...new Set(armaçõesFiltradas.map(item => item.marca))].sort();
      const modelos = [...new Set(armaçõesFiltradas.map(item => item.modelo))].sort();
      const categorias = [...new Set(armaçõesFiltradas.map(item => item.categoria))].sort();

      popularSelect("filtro-marca", marcas);
      popularSelect("filtro-modelo", modelos);
      popularSelect("filtro-categoria", categorias);
    }

    function popularSelect(id, options) {
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">Todos</option>`;
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });
    }

    function limparFiltros() {
      ["filtro-marca", "filtro-modelo", "filtro-categoria"].forEach(id => {
        const select = document.getElementById(id);
        if (select) select.innerHTML = `<option value="">Todos</option>`;
      });
    }

    function limparTabela() {
      const tbody = document.querySelector("#tabela-armações tbody");
      if (tbody) tbody.innerHTML = "";
    }

    // FILTRAR ARMAÇÕES PELA SELEÇÃO DOS FILTROS
    function filtrarArmações() {
      if (!lojaSelecionada) return;

      const marcaFiltro = document.getElementById("filtro-marca").value;
      const modeloFiltro = document.getElementById("filtro-modelo").value;
      const categoriaFiltro = document.getElementById("filtro-categoria").value;

      armaçõesFiltradas = dadosLojas[lojaSelecionada].filter(item => {
        return (!marcaFiltro || item.marca === marcaFiltro)
          && (!modeloFiltro || item.modelo === modeloFiltro)
          && (!categoriaFiltro || item.categoria === categoriaFiltro);
      });

      atualizarTabela();
    }

    function atualizarTabela() {
      const tbody = document.querySelector("#tabela-armações tbody");
      tbody.innerHTML = "";

      if (armaçõesFiltradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma armação encontrada.</td></tr>`;
        return;
      }

      armaçõesFiltradas.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.marca}</td>
          <td>${item.modelo}</td>
          <td>${item.quantidade}</td>
          <td>${item.preco}</td>
          <td>${item.categoria}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // FILTRAR LOJAS NA TELA PRINCIPAL
    function filtrarLojas() {
      const termo = document.getElementById("search-store").value.toLowerCase();
      const lojasList = document.getElementById("lojas-list");

      const lojasFiltradas = Object.keys(dadosLojas).filter(loja =>
        loja.toLowerCase().includes(termo)
      );

      if (lojasFiltradas.length === 0) {
        lojasList.innerHTML = "<p style='text-align:center; color:#666;'>Nenhuma loja encontrada.</p>";
        return;
      }

      lojasList.innerHTML = lojasFiltradas.map(loja => {
        const totalArmacoes = dadosLojas[loja].length;
        const totalQuantidade = dadosLojas[loja].reduce((sum, item) => sum + item.quantidade, 0);

        return `
          <div class="store-card" onclick="abrirLoja('${loja}')">
            <h3>${loja}</h3>
            <p><strong>${totalArmacoes}</strong> modelos de armações</p>
            <p><strong>${totalQuantidade}</strong> unidades no total</p>
          </div>
        `;
      }).join('');
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginForm").addEventListener("submit", processarLogin);
      document.getElementById("search-store").addEventListener("input", filtrarLojas);
    });
  </script>

</body>
</html>
